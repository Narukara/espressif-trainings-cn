# 项目结构

## esp-rs crates

不像大多数其他嵌入式平台，Espressif 支持 Rust 标准库。其中最值得关注的是，你可以任意使用大小可变的集合，例如 `Vec` 或 `HashMap`，以及基于 `Box` 的通用堆存储。你还可以自由地创建新线程，并使用 `Arc` 和 `Mutex` 等同步原语在它们之间安全地共享数据。尽管如此，内存在嵌入式系统上仍然是一种稀缺资源，因此需要注意不要耗尽它——尤其是，使用线程的代价可能会很高。

Services like WiFi, HTTP client/server, MQTT, OTA updates, logging etc. are exposed via Espressif's open source IoT Development Framework, [esp-idf](https://github.com/espressif/esp-idf). It is mostly written in C and as such is exposed to Rust in the canonical split crate style: 
- a `sys` crate to provide the actual `unsafe` bindings ([esp-idf-sys](https://github.com/esp-rs/esp-idf-sys))
- a higher level crate offering safe and comfortable Rust abstractions ([esp-idf-svc](https://github.com/esp-rs/esp-idf-svc/))

The final piece of the puzzle is low-level hardware access, which is again provided in a split fashion:
- [esp-idf-hal](https://github.com/esp-rs/esp-idf-hal) implements the hardware-independent [embedded-hal](https://github.com/rust-embedded/embedded-hal) traits like analog/digital conversion, digital I/O pins, or SPI communication - as the name suggests, it also uses `esp-idf` as a foundation
- if direct register manipulation is required, [esp32c3](https://github.com/esp-rs/esp32c3) provides the peripheral access create generated by svd2rust.

More information is available in the [ecosystem chapter](https://esp-rs.github.io/book/overview/using-the-standard-library.html) of the `esp-rs` book.

### Build toolchain

🔎 As part of a project build, `esp-idf-sys` will download [esp-idf](https://github.com/espressif/esp-idf), the C-based Espressif toolchain. The download destination is configurable; to save disk space and download time, all examples/exercises in the workshop repository are set to use one single `global` toolchain, installed in `~/.espressif`. See the `ESP_IDF_TOOLS_INSTALL_DIR` parameter in `esp-idf-sys`'s [README](https://github.com/esp-rs/esp-idf-sys#configuration) for other options.

## Package layout

On top of the usual contents of a Rust project created with `cargo new`, a few additional files and parameters are required. The examples/exercises in this workshop are already fully configured, and for creating new projects it is recommended to use the [cargo-generate](./03_2_cargo_generate.md) wizard based approach.

🔎 The rest of this page is optional knowledge that can come in handy should you wish to change some aspects of a project.

### `Cargo.toml`

This workshop is written around the `native` build system. Alternatively you may use `PlatformIO`/`pio`, however this is currently being deprecated.

```toml
[features]
default = ["native"]
native = ["esp-idf-sys/native"]
```

Some build dependencies must be set:

```toml
[build-dependencies]
embuild = "0.28"
anyhow = "1"
```

### Additional configuration files

- `build.rs` - [Cargo build script](https://doc.rust-lang.org/cargo/reference/build-scripts.html). Here: sets environment variables required for building.
- `.cargo/config.toml` - sets the target architecture and controls build details. This is the place to override `ESP_IDF_TOOLS_INSTALL_DIR` if you wish to do so.
- `sdkconfig.defaults` - overrides `esp-idf` specific parameters such as stack size or log level.
